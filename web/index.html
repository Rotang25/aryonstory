<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pov√≠dky</title>
    <script src="vue.js"></script>
    <script src="aryon.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #ddd;
            --header-bg: #f0f0f0;
            --header-border: #e0e0e0;
            --hover-bg: #f5f5f5;
            --hover-header: #d0d0d0;
        }
        body.dark-mode {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --header-bg: #2d2d2d;
            --header-border: #3d3d3d;
            --hover-bg: #2a2a2a;
            --hover-header: #3a3a3a;
        }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        #app { display: flex; gap: 20px; height: calc(100vh - 40px); flex-direction: column; }
        .header { display: flex; justify-content: flex-start; align-items: center; margin-bottom: 10px; height: auto; gap: 20px; }
        .header-left { display: flex; gap: 10px; align-items: center; }
        .header-right { display: none; }
        .theme-toggle { padding: 8px 12px; cursor: pointer; background: var(--header-bg); border: 1px solid var(--border-color); border-radius: 4px; white-space: nowrap; }
        .main-container { display: flex; gap: 20px; flex: 1; min-width: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .filters { margin-bottom: 20px; }
        .search-input { flex: 1; max-width: 300px; }
        .story-list { display: table; width: 100%; border-collapse: collapse; }
        .story-row { display: table-row; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .story-row:hover { background: var(--hover-bg); }
        .story-cell { display: table-cell; padding: 10px; border: 1px solid var(--border-color); }
        .story-header { display: table-header-group; background: var(--header-bg); font-weight: bold; }
        .story-header .story-cell { background: var(--header-border); }
        .story-header .story-cell { cursor: pointer; user-select: none; }
        .story-header .story-cell:hover { background: var(--hover-header); }
        .sort-indicator { margin-left: 5px; font-size: 12px; }
        .detail { margin-top: 20px; overflow-y: auto; }
        .back-btn { margin-bottom: 10px; }
        input, select { margin-right: 10px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .sidebar { width: 350px; display: flex; flex-direction: column; gap: 20px; flex-shrink: 0; }
        .label-row { display: flex; align-items: center; gap: 8px; font-size: 14px; white-space: nowrap; }
        .label-row input[type="checkbox"] { flex-shrink: 0; }
        .label-row span { flex: 1; }
        .label-checkboxes { display: flex; gap: 5px; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .sidebar-title { font-weight: bold; font-size: 14px; }
        .sidebar-legend { font-size: 12px; color: #666; }
        .labels-box { border: 1px solid #ccc; padding: 10px; height: 100%; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .sidebar-sort-btn { padding: 4px 8px; font-size: 12px; cursor: pointer; background: var(--header-bg); border: 1px solid var(--border-color); border-radius: 3px; white-space: nowrap; }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-left">
                <button class="theme-toggle" @click="toggleTheme">{{ isDarkMode ? '‚òÄÔ∏è Svƒõtl√Ω' : 'üåô Tmav√Ω' }}</button>
                <input v-model="dateFrom" placeholder="Od data (YYYY-MM-DD)" type="date">
                <input v-model="dateTo" placeholder="Do data (YYYY-MM-DD)" type="date">
                <input v-model="searchQuery" class="search-input" placeholder="Fulltextov√© vyhled√°v√°n√≠" type="text">
            </div>

        </div>
        <div class="main-container">
        <div class="main-content">
            <div v-if="currentView === 'list'">
                <div class="story-list">
                    <div class="story-header">
                        <div class="story-cell" style="width: 40%;" @click="setSortColumn('name')">
                            N√°zev <span class="sort-indicator" v-if="sortColumn === 'name'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                        </div>
                        <div class="story-cell" style="width: 20%;" @click="setSortColumn('time')">
                            Datum <span class="sort-indicator" v-if="sortColumn === 'time'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                        </div>
                        <div class="story-cell" style="width: 40%;">≈†t√≠tky</div>
                    </div>
                    <div v-for="story in sortedFilteredStories" :key="story._id" class="story-row" @click="selectStory(story)">
                        <div class="story-cell" style="width: 40%;">{{ story.name }}</div>
                        <div class="story-cell" style="width: 20%;">{{ new Date(story.time).toLocaleDateString('cs-CZ') }}</div>
                        <div class="story-cell" style="width: 40%;">{{ story.labels.join(', ') }}</div>
                    </div>
                </div>
            </div>
            <div v-else class="detail">
                <button class="back-btn" @click="backToList">Zpƒõt</button>
                <h2>{{ selectedStory.name }}</h2>
                <p>Autor: {{ selectedStory.autor }}</p>
                <p>Datum: {{ new Date(selectedStory.time).toLocaleDateString('cs-CZ') }}</p>
                <p>Labely: {{ selectedStory.labels.join(', ') }}</p>
                <div v-html="selectedStory.text"></div>
            </div>
        </div>
        <div class="sidebar" v-if="currentView === 'list'">
            <div class="sidebar-header">
                <div class="sidebar-title">≈†t√≠tky</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="sidebar-sort-btn" @click="cycleLabelSort" :title="labelSortMode === 'alpha-asc' ? 'A-Z' : labelSortMode === 'alpha-desc' ? 'Z-A' : 'Podle frekvence'">
                        {{ labelSortMode === 'alpha-asc' ? '‚ñ≤ A-Z' : labelSortMode === 'alpha-desc' ? '‚ñº Z-A' : 'üìä' }}
                    </button>
                    <div class="sidebar-legend">AND | OR</div>
                </div>
            </div>
            <div class="labels-box">
                <div v-for="label in sortedLabels" :key="label" class="label-row">
                    <span>{{ label }}</span>
                    <div class="label-checkboxes">
                        <input type="checkbox" :value="label" v-model="selectedLabelsAnd" title="AND">
                        <input type="checkbox" :value="label" v-model="selectedLabelsOr" title="OR">
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const stories = ref([]);
                const currentView = ref('list');
                const selectedStory = ref(null);
                const searchQuery = ref('');
                const selectedLabelsAnd = ref([]);
                const selectedLabelsOr = ref([]);
                const dateFrom = ref('');
                const dateTo = ref('');
                const sortColumn = ref('name');
                const sortDirection = ref('asc');
                const isDarkMode = ref(localStorage.getItem('darkMode') === 'true');
                const labelSortMode = ref(localStorage.getItem('labelSortMode') || 'alpha-asc'); // 'alpha-asc', 'alpha-desc', 'freq'

                const allLabels = computed(() => [...new Set(stories.value.flatMap(s => s.labels))]);
                const labelFrequency = computed(() => {
                    const freq = {};
                    stories.value.forEach(s => s.labels.forEach(l => freq[l] = (freq[l] || 0) + 1));
                    return freq;
                });
                const sortedLabels = computed(() => {
                    let sorted = [...allLabels.value];
                    if (labelSortMode.value === 'alpha-asc') {
                        sorted.sort((a, b) => a.localeCompare(b, 'cs'));
                    } else if (labelSortMode.value === 'alpha-desc') {
                        sorted.sort((a, b) => b.localeCompare(a, 'cs'));
                    } else if (labelSortMode.value === 'freq') {
                        sorted.sort((a, b) => (labelFrequency.value[b] || 0) - (labelFrequency.value[a] || 0));
                    }
                    return sorted;
                });

                // Funkce pro odstranƒõn√≠ HTML tag≈Ø z textu
                const stripHtml = (html) => {
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    return tmp.textContent || tmp.innerText || '';
                };

                const filteredStories = computed(() => {
                    return stories.value.filter(story => {
                        const plainText = stripHtml(story.text).toLowerCase();
                        const matchesSearch = !searchQuery.value ||
                            story.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                            plainText.includes(searchQuery.value.toLowerCase());
                        const matchesAndLabels = selectedLabelsAnd.value.length === 0 ||
                            selectedLabelsAnd.value.every(label => story.labels.includes(label));
                        const matchesOrLabels = selectedLabelsOr.value.length === 0 ||
                            selectedLabelsOr.value.some(label => story.labels.includes(label));
                        const storyDate = new Date(story.time);
                        const matchesDateFrom = !dateFrom.value || storyDate >= new Date(dateFrom.value);
                        const matchesDateTo = !dateTo.value || storyDate <= new Date(dateTo.value);
                        return matchesSearch && matchesAndLabels && matchesOrLabels && matchesDateFrom && matchesDateTo;
                    });
                });

                const sortedFilteredStories = computed(() => {
                    const sorted = [...filteredStories.value];
                    sorted.sort((a, b) => {
                        let aVal, bVal;
                        if (sortColumn.value === 'name') {
                            aVal = a.name.toLowerCase();
                            bVal = b.name.toLowerCase();
                        } else if (sortColumn.value === 'time') {
                            aVal = new Date(a.time).getTime();
                            bVal = new Date(b.time).getTime();
                        }
                        const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                        return sortDirection.value === 'asc' ? comparison : -comparison;
                    });
                    return sorted;
                });

                const selectStory = (story) => {
                    selectedStory.value = story;
                    currentView.value = 'detail';
                };

                const backToList = () => {
                    currentView.value = 'list';
                    selectedStory.value = null;
                };

                const setSortColumn = (column) => {
                    if (sortColumn.value === column) {
                        sortDirection.value = sortDirection.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn.value = column;
                        sortDirection.value = 'asc';
                    }
                };

                const toggleTheme = () => {
                    isDarkMode.value = !isDarkMode.value;
                    localStorage.setItem('darkMode', isDarkMode.value);
                    document.body.classList.toggle('dark-mode', isDarkMode.value);
                };

                const cycleLabelSort = () => {
                    const modes = ['alpha-asc', 'alpha-desc', 'freq'];
                    const currentIndex = modes.indexOf(labelSortMode.value);
                    const nextIndex = (currentIndex + 1) % modes.length;
                    labelSortMode.value = modes[nextIndex];
                    localStorage.setItem('labelSortMode', labelSortMode.value);
                };

                // Aplikuj ulo≈æen√Ω re≈æim p≈ôi startu
                if (isDarkMode.value) {
                    document.body.classList.add('dark-mode');
                }

                // Data jsou naƒçtena z stories.js
                stories.value = storiesData.map((story, index) => ({ ...story, _id: index, autor: story.autor || "Autor neuveden" }));

                return {
                    stories,
                    currentView,
                    selectedStory,
                    searchQuery,
                    selectedLabelsAnd,
                    selectedLabelsOr,
                    dateFrom,
                    dateTo,
                    sortColumn,
                    sortDirection,
                    isDarkMode,
                    labelSortMode,
                    allLabels,
                    sortedLabels,
                    labelFrequency,
                    filteredStories,
                    sortedFilteredStories,
                    selectStory,
                    backToList,
                    setSortColumn,
                    toggleTheme,
                    cycleLabelSort
                };
            }
        }).mount('#app');
    </script>
</body>
</html>