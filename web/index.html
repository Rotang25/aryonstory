<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Povídky</title>
    <script src="vue.js"></script>
    <script src="aryon.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        #app { display: flex; gap: 20px; height: calc(100vh - 40px); }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .filters { margin-bottom: 20px; }
        .story-list { display: table; width: 100%; border-collapse: collapse; }
        .story-row { display: table-row; border-bottom: 1px solid #ddd; cursor: pointer; }
        .story-row:hover { background: #f5f5f5; }
        .story-cell { display: table-cell; padding: 10px; border: 1px solid #ddd; }
        .story-header { display: table-header-group; background: #f0f0f0; font-weight: bold; }
        .story-header .story-cell { background: #e0e0e0; }
        .story-header .story-cell { cursor: pointer; user-select: none; }
        .story-header .story-cell:hover { background: #d0d0d0; }
        .sort-indicator { margin-left: 5px; font-size: 12px; }
        .detail { margin-top: 20px; overflow-y: auto; }
        .back-btn { margin-bottom: 10px; }
        input, select { margin-right: 10px; }
        .sidebar { width: auto; min-width: 200px; max-width: 500px; display: flex; flex-direction: row; gap: 20px; }
        .sidebar-column { flex: 1; display: flex; flex-direction: column; }
        .label-row { display: flex; align-items: center; gap: 8px; font-size: 14px; white-space: nowrap; }
        .label-row input[type="checkbox"] { flex-shrink: 0; }
        .label-row span { flex: 1; }
        .label-checkboxes { display: flex; gap: 5px; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .sidebar-title { font-weight: bold; font-size: 14px; }
        .sidebar-legend { font-size: 12px; color: #666; }
        .labels-box { border: 1px solid #ccc; padding: 10px; height: 100%; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="main-content">
            <div v-if="currentView === 'list'">
                <div class="filters">
                    <input v-model="searchQuery" placeholder="Fulltextové vyhledávání" type="text">
                    <input v-model="dateFrom" placeholder="Od data (YYYY-MM-DD)" type="date">
                    <input v-model="dateTo" placeholder="Do data (YYYY-MM-DD)" type="date">
                </div>
                <div class="story-list">
                    <div class="story-header">
                        <div class="story-cell" style="width: 30%;" @click="setSortColumn('name')">
                            Název <span class="sort-indicator" v-if="sortColumn === 'name'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                        </div>
                        <div class="story-cell" style="width: 20%;" @click="setSortColumn('autor')">
                            Autor <span class="sort-indicator" v-if="sortColumn === 'autor'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                        </div>
                        <div class="story-cell" style="width: 15%;" @click="setSortColumn('time')">
                            Datum <span class="sort-indicator" v-if="sortColumn === 'time'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                        </div>
                        <div class="story-cell" style="width: 35%;">Štítky</div>
                    </div>
                    <div v-for="story in sortedFilteredStories" :key="story._id" class="story-row" @click="selectStory(story)">
                        <div class="story-cell" style="width: 30%;">{{ story.name }}</div>
                        <div class="story-cell" style="width: 20%;">{{ story.autor }}</div>
                        <div class="story-cell" style="width: 15%;">{{ new Date(story.time).toLocaleDateString('cs-CZ') }}</div>
                        <div class="story-cell" style="width: 35%;">{{ story.labels.join(', ') }}</div>
                    </div>
                </div>
            </div>
            <div v-else class="detail">
                <button class="back-btn" @click="backToList">Zpět</button>
                <h2>{{ selectedStory.name }}</h2>
                <p>Autor: {{ selectedStory.autor }}</p>
                <p>Datum: {{ new Date(selectedStory.time).toLocaleDateString('cs-CZ') }}</p>
                <p>Labely: {{ selectedStory.labels.join(', ') }}</p>
                <div v-html="selectedStory.text.join('')"></div>
            </div>
        </div>
        <div class="sidebar">
            <div class="sidebar-column">
                <div class="sidebar-header">
                    <div class="sidebar-title">Štítky</div>
                    <div class="sidebar-legend">AND | OR</div>
                </div>
                <div class="labels-box">
                    <div v-for="label in sortedLabels" :key="label" class="label-row">
                        <span>{{ label }}</span>
                        <div class="label-checkboxes">
                            <input type="checkbox" :value="label" v-model="selectedLabelsAnd" title="AND">
                            <input type="checkbox" :value="label" v-model="selectedLabelsOr" title="OR">
                        </div>
                    </div>
                </div>
            </div>
            <div class="sidebar-column">
                <div class="sidebar-header">
                    <div class="sidebar-title">Autoři</div>
                </div>
                <div class="labels-box">
                    <div v-for="author in sortedAuthors" :key="author" class="label-row">
                        <span>{{ author }}</span>
                        <div class="label-checkboxes">
                            <input type="checkbox" :value="author" v-model="selectedAuthorsOr" title="OR">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const stories = ref([]);
                const currentView = ref('list');
                const selectedStory = ref(null);
                const searchQuery = ref('');
                const selectedAuthorsOr = ref([]);
                const selectedLabelsAnd = ref([]);
                const selectedLabelsOr = ref([]);
                const dateFrom = ref('');
                const dateTo = ref('');
                const sortColumn = ref('name');
                const sortDirection = ref('asc');

                const authors = computed(() => [...new Set(stories.value.map(s => s.autor))]);
                const sortedAuthors = computed(() => authors.value.sort((a, b) => a.localeCompare(b, 'cs')));
                const allLabels = computed(() => [...new Set(stories.value.flatMap(s => s.labels))]);
                const sortedLabels = computed(() => allLabels.value.sort((a, b) => a.localeCompare(b, 'cs')));

                const filteredStories = computed(() => {
                    return stories.value.filter(story => {
                        const matchesSearch = !searchQuery.value ||
                            story.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                            story.plaintext.toLowerCase().includes(searchQuery.value.toLowerCase());
                        const matchesAuthor = selectedAuthorsOr.value.length === 0 ||
                            selectedAuthorsOr.value.includes(story.autor);
                        const matchesAndLabels = selectedLabelsAnd.value.length === 0 ||
                            selectedLabelsAnd.value.every(label => story.labels.includes(label));
                        const matchesOrLabels = selectedLabelsOr.value.length === 0 ||
                            selectedLabelsOr.value.some(label => story.labels.includes(label));
                        const storyDate = new Date(story.time);
                        const matchesDateFrom = !dateFrom.value || storyDate >= new Date(dateFrom.value);
                        const matchesDateTo = !dateTo.value || storyDate <= new Date(dateTo.value);
                        return matchesSearch && matchesAuthor && matchesAndLabels && matchesOrLabels && matchesDateFrom && matchesDateTo;
                    });
                });

                const sortedFilteredStories = computed(() => {
                    const sorted = [...filteredStories.value];
                    sorted.sort((a, b) => {
                        let aVal, bVal;
                        if (sortColumn.value === 'name') {
                            aVal = a.name.toLowerCase();
                            bVal = b.name.toLowerCase();
                        } else if (sortColumn.value === 'autor') {
                            aVal = a.autor.toLowerCase();
                            bVal = b.autor.toLowerCase();
                        } else if (sortColumn.value === 'time') {
                            aVal = new Date(a.time).getTime();
                            bVal = new Date(b.time).getTime();
                        }
                        const comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                        return sortDirection.value === 'asc' ? comparison : -comparison;
                    });
                    return sorted;
                });

                const selectStory = (story) => {
                    selectedStory.value = story;
                    currentView.value = 'detail';
                };

                const backToList = () => {
                    currentView.value = 'list';
                    selectedStory.value = null;
                };

                const setSortColumn = (column) => {
                    if (sortColumn.value === column) {
                        sortDirection.value = sortDirection.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn.value = column;
                        sortDirection.value = 'asc';
                    }
                };

                // Data jsou načtena z stories.js
                stories.value = storiesData.map((story, index) => ({ ...story, _id: index, autor: story.autor || "Autor neuveden" }));

                return {
                    stories,
                    currentView,
                    selectedStory,
                    searchQuery,
                    selectedAuthorsOr,
                    selectedLabelsAnd,
                    selectedLabelsOr,
                    dateFrom,
                    dateTo,
                    sortColumn,
                    sortDirection,
                    authors,
                    sortedAuthors,
                    allLabels,
                    sortedLabels,
                    filteredStories,
                    sortedFilteredStories,
                    selectStory,
                    backToList,
                    setSortColumn
                };
            }
        }).mount('#app');
    </script>
</body>
</html>